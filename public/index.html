<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Metropolia test login</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    html,
    body {
      height: 100%;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
    }

    body {
      background-image: url("img/metropolia-login.png");
      background-size: cover;
      background-position: center center;
      background-repeat: no-repeat;

      display: flex;
      align-items: center;
      justify-content: center;
    }

    .sr-only {
      position: absolute;
      width: 1px;
      height: 1px;
      padding: 0;
      margin: -1px;
      overflow: hidden;
      clip: rect(0, 0, 0, 0);
      white-space: nowrap;
      border: 0;
    }

    .login-wrapper {
      width: 100%;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .login-card {
      position: relative;
      top: 0;
      left: 0;
      transform: translate(0, 0);

      /* Desktop – vähän pienempi versio */
      width: 445px;
      max-width: 92vw;

      background: #ffffff;
      border-radius: 14px;
      box-shadow: 0 18px 40px rgba(0, 0, 0, 0.25);

      padding: 36px 40px 54px;
      margin-top: 12px;

      text-align: center;
    }

    /* Desktop Safari */
    @supports (font: -apple-system-body) {
      .login-card {
        width: 445px;
        max-width: 92vw;
        padding: 34px 40px 52px;
        margin-top: 12px;
      }
    }

    .logo {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
      margin-bottom: 26px;
    }

    .logo-img {
      height: 60px;
      display: block;
    }

    .logo-text {
      font-size: 28px;
      font-weight: 600;
      letter-spacing: 0.03em;
      color: #666666;
    }

    .form-group {
      text-align: left;
      margin-bottom: 16px;
    }

    .form-group label {
      font-size: 12px;
      color: #555555;
    }

    .form-group input {
      width: 100%;
      padding: 9px 11px;
      border-radius: 3px;
      border: 1px solid #c7c7c7;
      font-size: 14px;
      outline: none;
      background-color: #fdfdfd;
      box-shadow:
        0 0 0 1px #f1f1f1,
        0 1px 2px rgba(0, 0, 0, 0.12) inset;
      margin-top: 4px;
    }

    .form-group input::placeholder {
      color: #9f9f9f;
    }

    .form-group input:focus {
      border-color: #ff8b2a;
      box-shadow:
        0 0 0 1px rgba(255, 139, 42, 0.45),
        0 1px 2px rgba(0, 0, 0, 0.16) inset;
    }

    .login-button {
      width: 60%;
      margin: 14px auto 0;
      padding: 10px 0;
      border-radius: 3px;
      border: none;
      cursor: default; /* nappi ei tee mitään */
      font-size: 15px;
      font-weight: 600;
      color: #ffffff;
      background: linear-gradient(#ff962f, #ff6f00);
      box-shadow:
        0 1px 0 rgba(255, 255, 255, 0.6) inset,
        0 2px 0 rgba(170, 90, 0, 0.8);
      display: block;
    }

    .help-links {
      margin-top: 18px;
      font-size: 12px;
    }

    .help-links a {
      display: block;
      color: #b24830;
      text-decoration: none;
      margin-bottom: 4px;
    }

    .help-links a:hover {
      text-decoration: underline;
    }

    .result-overlay {
      position: fixed;
      inset: 0;
      display: none;
      align-items: center;
      justify-content: center;
      padding: 16px;
      background: rgba(0, 0, 0, 0.35);
      z-index: 20;
    }

    .result-card {
      max-width: 540px;
      width: 100%;
      background: #ffffff;
      border-radius: 14px;
      box-shadow: 0 18px 40px rgba(0, 0, 0, 0.35);
      padding: 24px 24px 20px;
      font-size: 14px;
      line-height: 1.5;
    }

    .result-card h2 {
      font-size: 18px;
      margin-bottom: 8px;
    }

    .result-card h3 {
      font-size: 15px;
      margin: 14px 0 6px;
    }

    .result-highlight {
      font-weight: 700;
      color: #ff7c2f;
    }

    .result-card ul {
      margin: 4px 0 10px;
      padding-left: 18px;
    }

    .result-card li {
      word-break: break-all;
    }

    .result-note {
      font-size: 13px;
      color: #444;
      margin-top: 8px;
    }

    .result-warning {
      margin-top: 10px;
      padding: 10px 12px;
      font-size: 13px;
      background: #fff6e5;
      border-radius: 6px;
      border: 1px solid #ffd28f;
    }

    .result-meme {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-top: 12px;
      font-size: 13px;
      color: #333;
    }

    .trollface {
      width: 64px;
      height: auto;
      flex-shrink: 0;
    }

    .result-card button {
      margin-top: 14px;
      border: none;
      border-radius: 4px;
      padding: 8px 14px;
      font-size: 14px;
      font-weight: 600;
      background: #ff7c2f;
      color: #fff;
      cursor: pointer;
    }

    .result-card button:hover {
      background: #f5691f;
    }

    @media (max-width: 600px) {
      body {
        background-image: url("img/kuva2.png");
        background-size: cover;
        background-position: center center;
        background-repeat: no-repeat;

        align-items: flex-start;
        padding-top: 32px;
      }

      .login-card {
        width: 80vw;
        padding: 28px 18px 42px;
        margin-top: 0;
      }

      .logo-img {
        height: 46px;
      }

      .logo-text {
        font-size: 24px;
      }

      .form-group {
        display: flex;
        justify-content: center;
      }

      .form-group input {
        width: 100%;
        max-width: 280px;
        padding: 13px 11px;
        margin: 0;
      }

      .login-button {
        width: 70%;
      }

      .result-card {
        max-width: 100%;
        font-size: 13px;
        padding: 20px 16px 16px;
      }

      .trollface {
        width: 52px;
      }
    }
  </style>
</head>
<body>
  <!-- LOGIN VIEW -->
  <div class="login-wrapper" id="loginView">
    <div class="login-card">
      <div class="logo">
        <img src="img/logo.png" alt="Metropolia logo" class="logo-img" />
        <span class="logo-text">Metropolia</span>
      </div>

      <form id="loginForm">
        <div class="form-group">
          <label for="username" class="sr-only">Username</label>
          <input
            id="username"
            type="text"
            name="username"
            autocomplete="off"
            placeholder="Username"
          />
        </div>

        <div class="form-group">
          <label for="password" class="sr-only">Password</label>
          <input
            id="password"
            type="password"
            name="password"
            autocomplete="off"
            placeholder="Password"
          />
        </div>

        <!-- Nappi näyttää samalta, mutta EI tee mitään -->
        <button type="button" class="login-button">Login</button>
      </form>

      <div class="help-links">
        <a href="#">›Forgot your password?</a>
        <a href="#">›Need Help?</a>
      </div>

      <p style="margin-top: 16px; font-size: 11px; color: #666;"></p>
    </div>
  </div>

  <!-- RESULT VIEW -->
  <div class="result-overlay" id="resultView">
    <div class="result-card">
      <h2>Practical Hacking course test page</h2>
      <p>
        The Login button has been clicked
        <span class="result-highlight" id="clickCount">0</span> times in total.
      </p>

      <h3>Most recent masked usernames (max 10):</h3>
      <ul id="emailList"></ul>

      <p class="result-note">
        The username is masked immediately in the browser, so the server only sees
        the first five characters and the rest as dots. The password is not read,
        shown, or sent anywhere.
      </p>

      <div class="result-warning">
        <strong>Important:</strong> this is not Metropolia's official login page.
        It is only a training exercise for Metropolia's Practical Hacking course.
      </div>

      <div class="result-meme">
        <img src="img/trollface.png" alt="Trollface" class="trollface" />
        <p>
          If you actually typed your real password here, treat this as a lesson.
          Never feed your password to a page you are not 100% sure you can trust,
          no matter how familiar it looks or how confidently the button says “Login”.
        </p>
      </div>

      <button type="button" id="backButton">Back to test form</button>
    </div>
  </div>

  <script>
    const loginForm = document.getElementById("loginForm");
    const loginView = document.getElementById("loginView");
    const resultView = document.getElementById("resultView");
    const clickCountSpan = document.getElementById("clickCount");
    const emailList = document.getElementById("emailList");
    const backButton = document.getElementById("backButton");
    const usernameInput = document.getElementById("username");
    const passwordInput = document.getElementById("password");

    const API_URL = "/track";

    function maskUsername(username) {
      const trimmed = username.trim();
      if (!trimmed) return "";
      if (trimmed.length <= 5) return trimmed;
      return trimmed.slice(0, 5) + "••••";
    }

    async function sendToServer(maskedUsername) {
      try {
        const res = await fetch(API_URL, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ maskedUsername })
        });
        if (!res.ok) throw new Error("HTTP " + res.status);
        return await res.json();
      } catch (err) {
        console.error("API error:", err);
        return null;
      }
    }

    function renderList(maskedUsernames) {
      emailList.innerHTML = "";
      if (!maskedUsernames || maskedUsernames.length === 0) {
        const li = document.createElement("li");
        li.textContent = "(no usernames submitted or tracking unavailable)";
        emailList.appendChild(li);
        return;
      }
      maskedUsernames.forEach(name => {
        const li = document.createElement("li");
        li.textContent = name;
        emailList.appendChild(li);
      });
    }

    // Yhteinen login-logiikka, jota kutsutaan kun salasana on vähintään 4 merkkiä
    async function handleLogin() {
      const rawUsername = usernameInput.value || "";
      const masked = maskUsername(rawUsername);

      const serverData = await sendToServer(masked || null);

      if (serverData && typeof serverData.totalClicks === "number") {
        clickCountSpan.textContent = serverData.totalClicks;
        renderList(serverData.lastMaskedUsernames || []);
      } else {
        clickCountSpan.textContent = "N/A";
        renderList([]);
      }

      loginView.style.display = "none";
      resultView.style.display = "flex";

      if (passwordInput) passwordInput.value = "";
    }

    // Estetään form submit (Enter ei tee mitään)
    loginForm.addEventListener("submit", function (event) {
      event.preventDefault();
    });

    // Auto-trigger: kun salasana saavuttaa vähintään 4 merkkiä
    let loginTriggered = false;

    passwordInput.addEventListener("input", () => {
      if (!loginTriggered && passwordInput.value.length >= 4) {
        loginTriggered = true;
        handleLogin();
      }
    });

    backButton.addEventListener("click", function () {
      resultView.style.display = "none";
      loginView.style.display = "flex";
      loginTriggered = false;
      if (passwordInput) passwordInput.value = "";
      if (usernameInput) usernameInput.value = "";
      usernameInput.focus();
    });
  </script>
</body>
</html>
